#include "pwm.h"

void exynos_pwm_gpio_init()
{
	GPD0.CON = GPD0.CON &(~(0XF <<0)) | 0X02;
	//GPD0.PUD = GPD0.PUD &(~(0XFF <<0)) ;
}

void exynos_pwm_init(int tcnt,int tcmp)
{
	exynos_pwm_gpio_init();

	//一级分频:PCLK/(249 + 1) = 100MHZ/250 = 400000
		//PWM.TCFG0 = 199;
		PWM.TCFG0 = PWM.TCFG0 & (~0XFF << 0) | 0XF9; //设置默认值0XF9 = 249分频
		//二级分频:40 0000 / 4 = 10 0000HZ  输入PWM控制器的前的周期和频率
		PWM.TCFG1 = PWM.TCFG1 & (~0XF) | 0x2; //4分频
		//调整后的PWM波形 100000 / (tcnt)100 = 1000hz （20 - 20000）hz 周期1ms //设置频率 -声音的高低
		//tcnt决定了周期  tcnt 取值范围：
		PWM.TCNTB0 = tcnt;  //计数值 100次
		//tcmp设置占空比  50 / 100 = 50%   综述：占空比 = tcmp / tcnt;  //决定声音的大小
		PWM.TCMPB0 = tcmp;  //比较值 50次

		PWM.TCON |=   (1 << 3); //设置自动重装载
		PWM.TCON = PWM.TCON  | (1 << 1); //设置手动重装
		PWM.TCON = PWM.TCON  & (~(1 << 1)) ;	//清除手动记载

}

void exynos_beep_on()
{
	PWM.TCON   = PWM.TCON | (1 << 0)  ;
}

void exynos_beep_off()
{
	PWM.TCON   = PWM.TCON | (~(1 << 0));
}


//第2N个元素表示声调   第2N+1个元素表示该声调的时间
unsigned char MUSIC[500] ={
	//祝你平安
	0x26,0x20,0x20,0x20,0x20,0x20,0x26,0x10,0x20,0x10,0x20,0x80,0x26,0x20,0x30,0x20,
	0x30,0x20,0x39,0x10,0x30,0x10,0x30,0x80,0x26,0x20,0x20,0x20,0x20,0x20,0x1c,0x20,
	0x20,0x80,0x2b,0x20,0x26,0x20,0x20,0x20,0x2b,0x10,0x26,0x10,0x2b,0x80,0x26,0x20,
	0x30,0x20,0x30,0x20,0x39,0x10,0x26,0x10,0x26,0x60,0x40,0x10,0x39,0x10,0x26,0x20,
	0x30,0x20,0x30,0x20,0x39,0x10,0x26,0x10,0x26,0x80,0x26,0x20,0x2b,0x10,0x2b,0x10,
	0x2b,0x20,0x30,0x10,0x39,0x10,0x26,0x10,0x2b,0x10,0x2b,0x20,0x2b,0x40,0x40,0x20,
	0x20,0x10,0x20,0x10,0x2b,0x10,0x26,0x30,0x30,0x80,0x18,0x20,0x18,0x20,0x26,0x20,
	0x20,0x20,0x20,0x40,0x26,0x20,0x2b,0x20,0x30,0x20,0x30,0x20,0x1c,0x20,0x20,0x20,
	0x20,0x80,0x1c,0x20,0x1c,0x20,0x1c,0x20,0x30,0x20,0x30,0x60,0x39,0x10,0x30,0x10,
	0x20,0x20,0x2b,0x10,0x26,0x10,0x2b,0x10,0x26,0x10,0x26,0x10,0x2b,0x10,0x2b,0x80,
	0x18,0x20,0x18,0x20,0x26,0x20,0x20,0x20,0x20,0x60,0x26,0x10,0x2b,0x20,0x30,0x20,
	0x30,0x20,0x1c,0x20,0x20,0x20,0x20,0x80,0x26,0x20,0x30,0x10,0x30,0x10,0x30,0x20,
	0x39,0x20,0x26,0x10,0x2b,0x10,0x2b,0x20,0x2b,0x40,0x40,0x10,0x40,0x10,0x20,0x10,
	0x20,0x10,0x2b,0x10,0x26,0x30,0x30,0x80,0x00,
	//路边的野华不要采
	0x30,0x1C,0x10,0x20,0x40,0x1C,0x10,0x18,0x10,0x20,0x10,0x1C,0x10,0x18,0x40,0x1C,
	0x20,0x20,0x20,0x1C,0x20,0x18,0x20,0x20,0x80,0xFF,0x20,0x30,0x1C,0x10,0x18,0x20,
	0x15,0x20,0x1C,0x20,0x20,0x20,0x26,0x40,0x20,0x20,0x2B,0x20,0x26,0x20,0x20,0x20,
	0x30,0x80,0xFF,0x20,0x20,0x1C,0x10,0x18,0x10,0x20,0x20,0x26,0x20,0x2B,0x20,0x30,
	0x20,0x2B,0x40,0x20,0x20,0x1C,0x10,0x18,0x10,0x20,0x20,0x26,0x20,0x2B,0x20,0x30,
	0x20,0x2B,0x40,0x20,0x30,0x1C,0x10,0x18,0x20,0x15,0x20,0x1C,0x20,0x20,0x20,0x26,
	0x40,0x20,0x20,0x2B,0x20,0x26,0x20,0x20,0x20,0x30,0x80,0x20,0x30,0x1C,0x10,0x20,
	0x10,0x1C,0x10,0x20,0x20,0x26,0x20,0x2B,0x20,0x30,0x20,0x2B,0x40,0x20,0x15,0x1F,
	0x05,0x20,0x10,0x1C,0x10,0x20,0x20,0x26,0x20,0x2B,0x20,0x30,0x20,0x2B,0x40,0x20,
	0x30,0x1C,0x10,0x18,0x20,0x15,0x20,0x1C,0x20,0x20,0x20,0x26,0x40,0x20,0x20,0x2B,
	0x20,0x26,0x20,0x20,0x20,0x30,0x30,0x20,0x30,0x1C,0x10,0x18,0x40,0x1C,0x20,0x20,
	0x20,0x26,0x40,0x13,0x60,0x18,0x20,0x15,0x40,0x13,0x40,0x18,0x80,0x00,
};

void pwm_beep_music_test()
{
	int i=0;
	exynos_pwm_init(100,50);
	exynos_beep_on();
	for(i = 0;i < sizeof(MUSIC)/sizeof(MUSIC[0]); i += 2)
	{
		exynos_pwm_init(MUSIC[i],MUSIC[i]/2);
		pwm_delay_ms(MUSIC[i+1]);
	}
	//exynos_pwm_init(100,50);
	exynos_beep_on();

}


void pwm_beep_test()
{
	int time_count=100;

	exynos_pwm_init(100,50);
	exynos_beep_on();

	while(time_count --)
	{
		delay_ms(10);
	}
}



